// charge l'objet d'accès à winIbw// MTE 2012-02-07 ordre dans 856// 2014-10-09 : mte : vérif pour 181/182 : on enlève 200 $b et on ajoute 181 et 182// 2014-12-01 : mte : correction fonction recupererPpn : on utilise la variable p3, pas la zone// 2015-12-07 : SRY : prise en compte des notices ayant 2 zones 328 et message d'alerte indiquant qu'il faut ajouter la zone 456 dans la notice initiale// 2016-11-14 : SRY : remplacer la zone 303 par la zone 307// 2017-03-16 : SRY : modification RDA FR 2017 + modification zones 230, 303,304 et position zone 200 // 2017-06-01 : SRY : correction suite mise en place RDA FR 2017// 2018-01-04 : SRY : suppression zone 579// var application = Components.classes["@oclcpica.nl/kitabapplication;1"]        .getService(Components.interfaces.IApplication);		  function onLoad(){	// à l'ouverture de la boîte de dialogue		return true;}		  function onCancel(){	// The Cancel button is pressed..	//alert("Vous avez cliqué sur Annuler, Rien ne sera modifié.");	return true;}function picaCopyRecord() {	var bCodedData = application.activeWindow.codedData;		application.activeWindow.codedData = false;	application.activeWindow.noviceMode = false;		application.activeWindow.command("\\too unm", false);	application.activeWindow.copyTitle();	var matCode = application.activeWindow.materialCode;	var forceDocType = matCode.substr(0, 2);		application.activeWindow.command("\\sys 1; \\bes 1", false);			application.activeWindow.materialCode = forceDocType;		// crée une notice vide (cre)	application.activeWindow.command("\\inv 1", false);		if ((application.activeWindow.status == "OK") && (application.activeWindow.title != null)) {		application.activeWindow.pasteTitle();		if (bCodedData) {			application.activeWindow.codedData = true;		}		application.activeWindow.title.endOfBuffer(false);	}}// 20170601 : correction suite mise en place RDA FR 2017function modifier181(){	application.activeWindow.title.startOfBuffer (false);	var res = application.activeWindow.title.findTag ("181", 0, true, true, false);		if (res != "")	{		//on laisse la 181 telle quelle	} 	else	{		ajouter("181 ##$P01$ctxt");	}}function modifier200(){	application.activeWindow.title.startOfBuffer (false);	var res = application.activeWindow.title.findTag ("200", 0, true, true, false);	if (res != "")	{		application.activeWindow.title.deleteLine(1);		application.activeWindow.title.endOfBuffer (false);		//on enlève le $b		application.activeWindow.title.insertText (res.replace("$bTexte imprimé","") + "\n");	}}function modifier105(){	application.activeWindow.title.startOfBuffer (false);	var res = application.activeWindow.title.findTag ("105", 0, true, true, false);	if (res != "")	{		application.activeWindow.title.deleteLine(1);		application.activeWindow.title.endOfBuffer (false);		var res_search_m = res.search(/\$bm/);		var res_search_7 = res.search(/\$b7/);		if (res_search_m > 0 || res_search_7 > 0 )		{			if (res_search_m > 0 ) {				res = res.replace("$bm","$bv");				res = res.replace("$b7","");			} else {				res = res.replace("$b7","$bv");			}		}		application.activeWindow.title.insertText (res + "\n");		}}// SRY 20151207 : prise en compte de toutes les zones 328function modifier328(){    var tabres = new Array;    var indicateurs = "";    var res = "";    var i =0;    do    {        application.activeWindow.title.startOfBuffer (false);        res = application.activeWindow.title.findTag ("328", 0, true, true, false);        if (res != "")        {            indicateurs = res.substring(4,6);            tabres[i] = res.replace("328 " + indicateurs,"328 #0$zReproduction de") + "\n";            application.activeWindow.title.deleteLine(1);            i++;        }    } while (res != "")    for (i=0;i<tabres.length;i++)    {        application.activeWindow.title.endOfBuffer (false);        application.activeWindow.title.insertText (tabres[i]);    }} function supprimerRemplacer(ancienneZone, nouvelleZone){		application.activeWindow.title.startOfBuffer (false);	var res = application.activeWindow.title.findTag (ancienneZone, 0, true, true, false);	while (res != "")	{		application.activeWindow.title.deleteLine(1);		res = application.activeWindow.title.findTag (ancienneZone, 0, true, true, false);	}	application.activeWindow.title.endOfBuffer (false);	application.activeWindow.title.insertText (nouvelleZone + "\n");}function supprimer(zone){		application.activeWindow.title.startOfBuffer (false);	var res = application.activeWindow.title.findTag (zone, 0, true, true, false);	while (res != "")	{		application.activeWindow.title.deleteLine(1);		res = application.activeWindow.title.findTag (zone, 0, true, true, false);	}}function ajouter(zone){	application.activeWindow.title.endOfBuffer (false);	application.activeWindow.title.insertText (zone + "\n");}// 20170316 : modification RDA FR 2017// 20170601 : correction suite mise en place RDA FR 2017// 20180104 : SRY : suppression zone 579function modifierNotice(ancienPpn){			application.activeWindow.title.startOfBuffer (false);		supprimer("000");	supprimer("00A");	supprimer("002");	supprimer("003");	supprimerRemplacer("008", "008 $aOax3");	supprimer("010");	supprimer("035");	supprimerRemplacer("100","100 0#$aAnnée de mise en ligne");	modifier105();	supprimer("106");	ajouter("135 ##$ad$br");	modifier181();	supprimerRemplacer("182","182 ##$P01$cc");	supprimerRemplacer("183","183 ##$P01$aceb");	modifier200();	supprimer("210");	supprimer("215");	//on ajoute la $219 ou bien on la remplace si elle existe déjà	supprimerRemplacer("219","219 #2$aLieu de diffusion$cNom du diffuseur$dDate de diffusion");	ajouter("230 ##$aDonnées textuelles");	supprimerRemplacer("303","303 ##$aDescription d'après la consultation, AAAA-MM-JJ");	ajouter("304 ##$aTitre provenant de l'écran-titre -- Titre provenant des métadonnées -- Titre provenant du conteneur -- Titre provenant de la page de titre du document numérisé");	ajouter("307 ##$aL'impression du document génère XXX p.");	modifier328();	ajouter("337 ##$aUn logiciel capable de lire un fichier au format (préciser le format)");	ajouter("455 $0" + ancienPpn);	supprimer("579");	supprimer("801");	supprimer("802");	supprimer("830");	ajouter("856 4#$qFormat$uAdresse URL (si l'accès est réservé, créer une E856)$zAccès au texte intégral");		}function recupererPpn(){	application.activeWindow.command("mod", false);	//var zone001 = application.activeWindow.title.findTag ("001", 0, true, true, false);	//var ppn = zone001.substring(4, zone001.length);	ppn = application.activeWindow.getVariable("P3GPP"); // recupère le ppn	application.activeWindow.simulateIBWKey("FE");	return ppn;	}function transfoTheseImpTheseElec(){	var prompts = Components.classes["@mozilla.org/embedcomp/prompt-service;1"]                        .getService(Components.interfaces.nsIPromptService);	var bCodedData = application.activeWindow.codedData;	application.activeWindow.codedData = false;		var ppn = recupererPpn();	picaCopyRecord();	modifierNotice(ppn);		// SRY le 22/01/2016	prompts.alert(null,"CAT_transfoTheseImpTheseElec : " , "une fois la notice validée, modifier le ppn " + ppn + " et ajouter la zone 456 ##$0 + le nouveau ppn généré");	application.activeWindow.title.endOfBuffer(false);	application.activeWindow.title.insertText("une fois la notice validée, modifier le ppn " + ppn + " et ajouter la zone 456 ##$0 + le nouveau ppn généré\n");	application.activeWindow.codedData = bCodedData;}